---
layout: post
title: ODE講座22：ODEでポリゴンを簡単に表示する方法
date: 2007-11-01 22:49:21.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- ode
tags: []
meta:
  _edit_last: '2'
  views: '6421'
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/robot/9ode/460.html"
---
<p><img title="Open Dynamics Engine" src="{{ site.baseurl }}/assets/images/2007/11/rabit.jpg" alt="ODE texture" width="600" height="420" /></p>
<p><span style="font-size: x-small;"> <a href="http://archive3d.net/">Archive3D.net</a>からダウンロードした3DSフォーマットの「<a href="http://archive3d.net/?a=download&amp;id=8059">うさちゃん</a>」。lib3dsライブラリを使うことでODE付属のdrawstuffで表示できました。</span></p>
<p>早いものでもう１１月ですね。卒業研究や修士研究に取り組んでいる方はお尻に火か着くころではないでしょうか。</p>
<p>さて、ODE (Open Dynamics Engine）講座の22回目です。ODEに付属している３次元グラフィクスライブラリdrawstuffでは３Dモデルのファイルを読み込みません。ひびきのさんはXファイル（あの謎が謎を呼ぶTV番組ではありません。最も最近はPrison Breakに夢中ですが...）を読み込む<a href="http://hwm7.gyao.ne.jp/shinpuku/column05.html">X File　Loader</a>を公開しています。 ここではもう一つの標準的な3Dファイルである3DSを読み込むサンプルプログラムをテスト公開します。</p>
<p><!--more--></p>
<p>3dsファイルを読み込むライブラリとしてlib3dsを使います。これはJan Eric Kyprianidisさんが開発したものでLGPLで公開されています。<a href="http://lib3ds.sourceforge.net/">lib3dsのウェブサイトはここです。</a></p>
<p>まず、lib3dsをインストールしましょう。方法はODEと同じで 以下の要領です。MSYS+MinGW+Windows Vista環境で問題なくできました。</p>
<ul>
<li>./configure</li>
<li>make</li>
<li>make install</li>
</ul>
<p>後は、このode3dsloader-0.0.tgzファイルを次のリンクからダウンロードして、</p>
<ul>
<li> <a href="http://demura.net/archives/images/ode/ode3dsloader-0.0.tgz">3DS Loader for Open Dynamics Engine 0.0</a> (2007-11-1)</li>
</ul>
<p>今までのサンプルプログラムと同じように展開し、make、実行してください。ただし、このプログラムは完全ではなく、複数の部品で構成されるモデルを表示しようとするとエラーになります。また、テクスチャも表示できません。そのためにはdrawstuffのソースを変更しなければなりません。今後の宿題とします。</p>
<p>なお、3dsファイルを表示するためには、そのファイルが必要になります。上図の<a href="http://archive3d.net/?a=download&amp;id=8059">うさちゃん</a>は<a href="http://archive3d.net/">Archive3D.net</a>の<a href="http://archive3d.net/?a=download&amp;id=8059">ここからダウンロード</a>しました。</p>
<p>以下にソースコードの主要部分を掲載します。3dsファイルを読み込む関数がload3dsModel()です。読み込みが終わると頂点配列Vertices[]とインデックス配列Indices[]にデータが格納されるので、後はODE付属のdemoプログラムdemo_moving_trimesh.cppと同じようにプログラムするとポリゴンデータを扱うことができます。</p>
<p>つまり、一般ユーザはload3dsModel()を一行入れるだけで3dsファイルを読み込むことができます。簡単ですね。</p>
<p><strong><span style="color: #cc0000;">まだ、テスト公開中で不完全です。複数のオブジェクトで構成される3dsデータを表示できなければなりません。コメント頂ければありがたいです。</span></strong></p>
<hr />
<p>[code]<br />
 // main.cppから抜粋  by Kosei Demura 2007-11-1<br />
 //<br />
 #include<br />
 #include<br />
 #include "ode3dsloader.h"<br />
 extern int MeshCount;　// オブジェクト数</p>
<p>void makeModel()<br />
 {<br />
 static dReal weight = 10.0;<br />
 dReal x0 = 0, y0 = 0, z0 = 1.0;<br />
 dMass m;</p>
<p>// 3dsファイルをロードする関数。引数は3dsファイル名<br />
 load3dsModel("../models/rabbit.3DS");</p>
<p>TriData = (dTriMeshDataID *) malloc(MeshCount * sizeof(dTriMeshDataID));</p>
<p>model  = (MyObject *) malloc (MeshCount * sizeof(MyObject));</p>
<p>for (int i = 0; i &lt; MeshCount; i++) {<br />
 // rigid body<br />
 model[i].body = dBodyCreate(world);<br />
 dBodySetPosition(model[i].body, x0, y0, z0);</p>
<p>// for a trimesh object<br />
 TriData[i] = dGeomTriMeshDataCreate();</p>
<p>dGeomTriMeshDataBuildSingle(TriData[i], trimesh[i].vertices, 3 * sizeof(float), trimesh[i].vertexCount, trimesh[i].indices, trimesh[i].indexCount * 3, 3 * sizeof(int));</p>
<p>model[i].geom = dCreateTriMesh(space, TriData[i], 0, 0, 0);</p>
<p>// remember the mesh’s dTriMeshDataID on its userdata for convenience.<br />
 dGeomSetData(model[i].geom, TriData[i]);</p>
<p>dMassSetTrimeshTotal(&amp;m, weight, model[i].geom);<br />
 dGeomSetPosition(model[i].geom, -m.c[0], -m.c[1], -m.c[2]);<br />
 dMassTranslate(&amp;m, -m.c[0], -m.c[1], -m.c[2]);</p>
<p>dGeomSetBody(model[i].geom, model[i].body);<br />
 dBodySetMass(model[i].body, &amp;m);</p>
<p>dMatrix3 Rotation;<br />
 dRFromAxisAndAngle(Rotation, 0, 0, 1, -M_PI/4);<br />
 dBodySetRotation(model[i].body, Rotation);<br />
 }<br />
 }</p>
<p>[/code]</p>
<p>[code]<br />
 // ode3dsloader.cpp by Kosei Demura 2007-11-01<br />
 // 3dsフォーマットで作られたオブジェクトを読み込むプログラム<br />
 // このファイルでload3dsModel()関数を実装している。<br />
 // Todo：１つの3Dモデルが複数のオブジェクトで構成されているとエラーになる。<br />
 // lib3dsライブラリが必要http://lib3ds.sourceforge.net/<br />
 #include "ode3dsloader.h"<br />
 #define BASE_LENGTH  1.0      // メッシュモデルのバウンディングボックスの最大長さ[m]<br />
 #define MAX_OBJECTS  1000   // オブジェクトの数</p>
<p>typedef struct<br />
 {<br />
 float *vertices;<br />
 unsigned int vertexCount;<br />
 int *indices;<br />
 unsigned int indexCount;<br />
 } MyTrimesh;</p>
<p>extern MyTrimesh *trimesh;</p>
<p>dReal MIN_X = dInfinity, MAX_X = - dInfinity;<br />
 dReal MIN_Y = dInfinity, MAX_Y = - dInfinity;<br />
 dReal MIN_Z = dInfinity, MAX_Z = - dInfinity;<br />
 dReal ADJUST;<br />
 Lib3dsFile *file=0;</p>
<p>int MeshCount  = 0;</p>
<p>int vCount[MAX_OBJECTS], iCount[MAX_OBJECTS];</p>
<p>void calModel(Lib3dsMesh *mesh, int *points, int *faces)<br />
 {<br />
 *points = mesh-&gt;points;<br />
 *faces  = mesh-&gt;faces;<br />
 }</p>
<p>int meshDump(int no, Lib3dsMesh *mesh)<br />
 {<br />
 if (mesh-&gt;points == 0) return 0;</p>
<p>for (int i=0; i&lt; (int) mesh-&gt;points; i++) {<br />
 trimesh[no].vertices[3*i]   = mesh-&gt;pointL[i].pos[0];<br />
 trimesh[no].vertices[3*i+1] = mesh-&gt;pointL[i].pos[1];<br />
 trimesh[no].vertices[3*i+2] = mesh-&gt;pointL[i].pos[2];<br />
 if (MIN_X &gt; mesh-&gt;pointL[i].pos[0]) MIN_X = mesh-&gt;pointL[i].pos[0];<br />
 if (MIN_Y &gt; mesh-&gt;pointL[i].pos[1]) MIN_Y = mesh-&gt;pointL[i].pos[1];<br />
 if (MIN_Z &gt; mesh-&gt;pointL[i].pos[2]) MIN_Z = mesh-&gt;pointL[i].pos[2];<br />
 if (MAX_X &lt; mesh-&gt;pointL[i].pos[0]) MAX_X = mesh-&gt;pointL[i].pos[0];<br />
 if (MAX_Y &lt; mesh-&gt;pointL[i].pos[1]) MAX_Y = mesh-&gt;pointL[i].pos[1];<br />
 if (MAX_Z &lt; mesh-&gt;pointL[i].pos[2]) MAX_Z = mesh-&gt;pointL[i].pos[2];<br />
 }</p>
<p>for (int i=0; i&lt; (int) mesh-&gt;faces; i++) {<br />
 trimesh[no].indices[3*i]   = mesh-&gt;faceL[i].points[0];<br />
 trimesh[no].indices[3*i+1] = mesh-&gt;faceL[i].points[1];<br />
 trimesh[no].indices[3*i+2] = mesh-&gt;faceL[i].points[2];<br />
 }<br />
 return 1;<br />
 }</p>
<p>// トライメッシュデータのサイズ変更<br />
 int normalize(int no, Lib3dsMesh *mesh)<br />
 {<br />
 if (mesh-&gt;points == 0) return 0;</p>
<p>for (int i=0; i&lt; (int) mesh-&gt;points; i++) {<br />
 trimesh[no].vertices[3*i]   　*= (dReal) ADJUST;<br />
 trimesh[no].vertices[3*i+1] *= (dReal) ADJUST;<br />
 trimesh[no].vertices[3*i+2] *= (dReal) ADJUST;<br />
 }<br />
 return 1;<br />
 }</p>
<p>void load3dsModel(const char *filename)<br />
 {<br />
 int points, faces, no;<br />
 Lib3dsMesh *p;</p>
<p>file = lib3ds_file_load(filename);<br />
 if (!file) {<br />
 puts("3dsplayer: Error: Loading 3DS file failed.\n");<br />
 exit(1);<br />
 }</p>
<p>for (p=file-&gt;meshes; p!=0; p=p-&gt;next) {<br />
 calModel(p, &amp;points, &amp;faces);<br />
 if (points == 0) continue;<br />
 MeshCount++;<br />
 }</p>
<p>trimesh   = (MyTrimesh *) malloc(MeshCount * sizeof(MyTrimesh));<br />
 no = 0;<br />
 for (p=file-&gt;meshes; p!=0; p=p-&gt;next) {<br />
 calModel(p, &amp;points, &amp;faces);<br />
 if (points == 0) continue;</p>
<p>vCount[no] = points;<br />
 iCount[no] = faces;<br />
 trimesh[no].vertices = (float *) malloc(vCount[no]  * sizeof(float) * 3);<br />
 trimesh[no].indices  = (int *)    malloc(iCount[no]   * sizeof(int)    * 3);<br />
 trimesh[no].vertexCount = vCount[no];<br />
 trimesh[no].indexCount  = iCount[no];<br />
 no++;<br />
 }</p>
<p>no = 0;<br />
 for (p=file-&gt;meshes; p!=0; p=p-&gt;next) {<br />
 if (meshDump(no, p)) no++;<br />
 }</p>
<p>dReal maxLength;</p>
<p>if (MAX_X - MIN_X &gt;= MAX_Y - MIN_Y) {<br />
 if (MAX_X - MIN_X &gt;= MAX_Z - MIN_Z) maxLength = MAX_X - MIN_X;<br />
 else                                                      maxLength = MAX_Z - MIN_Z;<br />
 }<br />
 else {<br />
 if (MAX_Y - MIN_Y &gt;= MAX_Z - MIN_Z) maxLength = MAX_Y - MIN_Y;<br />
 else                                maxLength = MAX_Z - MIN_Z;<br />
 }</p>
<p>ADJUST = BASE_LENGTH / maxLength;</p>
<p>no = 0;<br />
 for (p=file-&gt;meshes; p!=0; p=p-&gt;next) {<br />
 if (normalize(no, p)) no++;<br />
 }<br />
 }<br />
 [/code]</p>
<p>[code]<br />
 // ode3dsloader.h</p>
<p>#include<br />
 #include<br />
 // for lib3ds<br />
 #include  #include  #include  #include  #include  #include  #include  #include  #include</p>
<p>void load3dsModel(const char *filename);</p>
<p>[/code]</p>
<hr />
<p>続く...</p>
<p><br class="spacer_" /></p>
