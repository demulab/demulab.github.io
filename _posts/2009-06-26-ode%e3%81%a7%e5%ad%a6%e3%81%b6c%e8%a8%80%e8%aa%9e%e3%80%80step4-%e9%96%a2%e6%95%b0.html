---
layout: post
title: 'ODEで学ぶC言語　[Step4: 関数]'
date: 2009-06-26 07:35:28.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- ode
tags: []
meta:
  syntaxhighlighter_encoded: '1'
  _edit_last: '2'
  views: '2373'
  image: http://demura.net/archives/images/ode/sample1.jpg
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/robot/9ode/4265.html"
---
<p><img title="落下する赤い球" src="{{ site.baseurl }}/assets/images/2009/06/sample1.jpg" alt="ODE" width="320" height="310" /></p>
<p>ODEで学ぶC言語のStep4です．今回は関数を練習しましょう．関数については既にわかっているものとし，ホームワークを通じて関数を使うとプログラムがとても簡単になることを実感してもらうことが狙いです．</p>
<p>今まで描画について学んできましたが，今回から動力学計算も学んでいきます．サンプルプログラムとしては，物理シミュレーションで最も簡単な物体の落下を取り上げます．プログラミングの教科書では初めの例題はHello Worldを表示する例が定番です。ここではHello Worldの物理シミュレーション版を紹介します．</p>
<p>ODEを使ったシミュレーションの流れを代表的なAPIと関連付けて列挙します。</p>
<ul>
<li><strong>シミュレーションの流れ</strong>
<ul>
<li><span style="color: #000066;"><strong>ODEの初期化 </strong></span><span style="color: #cc0000;"><strong>dInitODE() </strong></span></li>
<li><span style="color: #cc0000;"><strong><span style="color: #000000; font-weight: normal;"><span style="color: #000066;"><strong>動力学計算の世界worldの生成</strong> </span><span style="color: #cc0000;"><strong>dWorldCreate() </strong></span></span></strong></span></li>
<li><span style="color: #cc0000;"><strong><span style="color: #000000; font-weight: normal;"><span style="color: #cc0000;"><strong><span style="color: #000000; font-weight: normal;"><span style="color: #000066;"><strong>重力加速度の設定</strong> </span><span style="color: #cc0000;"><strong>dWorldSetGravity</strong></span><strong><span style="color: #cc0000;">()</span></strong></span></strong></span></span></strong></span></li>
<li><span style="color: #cc0000;"><strong><span style="color: #000000; font-weight: normal;"><span style="color: #cc0000;"><strong><span style="color: #000000; font-weight: normal;"><strong><span style="color: #cc0000;"><strong>剛体の生成</strong></span></strong></span></strong></span></span></strong></span>
<ul>
<li><span style="color: #000066;"><strong>質量の設定</strong></span><strong> dBodySetMass()</strong></li>
<li><strong><span style="font-weight: normal;"><span style="color: #000066;"><strong>位置の設定 </strong></span><span style="color: #cc0000;"><strong>dBodySetPosition()</strong></span></span></strong></li>
<li><strong><span style="font-weight: normal;"><span style="color: #cc0000;"><strong><span style="color: #000000; font-weight: normal;"><span style="color: #000066;"><strong>姿勢の設定</strong></span><span style="color: #cc0000;"><strong> dBodySetRotation()</strong></span></span></strong></span></span></strong></li>
</ul>
</li>
<li><strong>シミュレーションループ(この部分は繰り返し実行される)</strong>
<ul>
<li><span style="color: #000066;"><strong>動力学計算の実施</strong></span><span style="color: #cc0000;"> <strong>dWorldStep()</strong></span></li>
<li><span style="color: #cc0000;"><strong><strong>シミュレーションに必要な処理を書く</strong></strong></span></li>
</ul>
</li>
<li><span style="color: #000066;"><strong>動力学worldの破壊</strong></span><span style="color: #cc0000;"> <strong>dWorldDestroy()</strong></span></li>
<li><span style="color: #cc0000;"><strong><span style="color: #000000; font-weight: normal;"><span style="color: #000066;"><strong>ODEの終了 </strong></span><span style="color: #cc0000;"><strong>dCloseODE()</strong></span></span></strong></span></li>
</ul>
</li>
<li><strong>動力学計算</strong>
<ul>
</ul>
<p style="padding-left: 25px;">シミュレーションの流れでは色々なAPIを使っていますが、今回は物理エンジンの最も重要な動力学計算のＡＰＩについて説明します。動力学計算をするAPIはdWorldStep()です．このAPIはシミュレーションで毎回呼び出さなければいけないのでサンプルプログラムのようにsimLoop関数の中で呼び出してください．</p>
<ul>
<li><strong>void dWorldStep(dWorldID, dReal stepsize)；</strong></li>
</ul>
<p>シミュレーションを引数stepsieze[s]だけ１ステップ進めます。stepsizeは数値積分の時間刻み幅、単位は秒。大きいと精度が悪くなりますが、スピードは遅くなります。</p>
</li>
<li><strong>void dWorldQuickStep(dWorldID, dReal stepsize);<br />
 </strong></li>
</ul>
<li><strong>ソースコード</strong>
<ul />
<p>次に、詳しいコメントのついたソースコードを以下に示します。main関数から読んでください。</p>
<pre class="brush:cpp">/* step4 リンゴ（林檎）の落下 　*/
#include "dm4.h"

dWorldID world;                     // 動力学の世界
dBodyID  apple;                     // リンゴ
dReal    r = 0.2, m = 1.0;          // リンゴの半径,質量

void simLoop(int pause)   /***  シミュレーションループ　***/
{
  dWorldStep(world,0.01);    // シミュレーションを1ステップ進める

  dsSetColor(1.0,0.0,0.0);       // 赤色の設定(r,g,b)
  const double *p = dBodyGetPosition(apple);  // 位置を取得
  const double *R = dBodyGetRotation(apple);  // 姿勢を取得
  dsDrawSphere(p,R,r);                   // リンゴの描画
}

int main()         /*** main関数 ***/
{
　dInitODE();                              // ODEの初期化
  world = dWorldCreate();                  // 世界の創造
  dWorldSetGravity(world,0,0,-0.2);        // 重力設定

  apple = dBodyCreate(world);              // リンゴの生成

  dMass mass;                        // 構造体massの宣言
  dMassSetZero(&amp;mass);              // 構造体massの初期化
  dMassSetSphereTotal(&amp;mass,m,r);  // 構造体massに質量を設定
  dBodySetMass(apple,&amp;mass);       // リンゴにmassを設定

  dBodySetPosition(apple, 0.0, 0.0, 2.0);  // 位置設定(x,y,z)
  dmLoop(800, 600);                //  ウインドウの幅，高

　dWorldDestroy(world);           // 世界の破壊
　dCloseODE();                       // ODEの終了
  return 0;
}
</pre>
<li>これは赤玉の自由落下のプログラムです。ODEのシミュレーションの流れでは、まず、dInitODE()でODEを初期化します。次に、物理計算をするworld（ワールド）をdWorldCreate()で作ります。物理計算を受ける物体はその中に作らなければなりません。ODEでは物体のことをbody（ボディ）と呼んでいます。物体はdBodyCreate(world)で作ります。物体を作ったら、次にその質量パラメータと位置や姿勢を設定します。このプログラムでは球の質量パラメータと位置だけを設定しています。
<p>物体の生成と設定が終わったら、次はシミュレーションを進めます。これはdmLoop()で繰り替えしsimLoop関数が呼び出すことにより実行されています。simLoop関数のdWorldStep(world, 0.05)はシミュレーションを1ステップ進めています。進める時間は２番目の引数、この場合は0.05秒となります。dsDrawSphere()で落下する球を表示しています。</p>
<p>シミュレーションが終わると，後片付けを行います。dWorldDestroy(world)でワールドを破壊し，dCloseODE()でODEの終了処理をします。</p>
<p>なお、小文字のdで始まる関数はODEのAPI(application interface)で、dsで始まる関数はdrawstuff(ドロースタッフ）のAPIです。drawstuffはODE付属テストプログラム表示用のライブラリのことです。最後に，dmで始まる関数は私の作成した関数です．</p>
<p>ここでは重力加速度を赤玉がゆっくり落下していきますが、なんと地面を通り抜けて消えてしまいます。実は上のプログラムには衝突検出機能が組み込まれていなかったのです。</p>
</li>
</li>
<li>ホームワーク
<ol>
<li><a href="http://demura.net/wordpress/wp-content/uploads/2009/06/step4-090626.zip">step4-090626.zip</a>をダウンロードして実行しよう！</li>
<li>ODE本を読んで，ボックス（直方体）を落下させよ！</li>
<li>ODE本を読んで，円柱を落下させよ！</li>
<li>ODE本を読んで，カプセルを落下させよ！</li>
<li>上で作成したプログラムの中で球を作るところを関数化しなさい．引数として位置，姿勢，物体生成に必要なパラメータを使うこと．
<ul>
<li>dBodyID  dmCreateSphere(double p[3],  double  R[12],  double  r , double m);</li>
<li>位置　p[3], 　姿勢　R[12],  半径 r, 　質量　m</li>
</ul>
</li>
<li>同様にボックスの生成を関数化しなさい．
<ul>
<li>dBodyID  dmCreateBox(double p[3], double R[12], double sides[3], double m);</li>
<li>位置　p[3], 　姿勢　R[12],  サイズ sides[3], 半径 r, 　質量　m</li>
</ul>
</li>
<li>円柱の生成を関数化しなさい．
<ul>
<li>dBodyID  dmCreateCylinder(double p[3], double R[12], double l, double r, double  m, int dir);</li>
<li>位置　p[3], 　姿勢　R[12],  半径 r, 　質量　m,  長軸の方向　dir</li>
</ul>
</li>
<li>カプセルの生成を関数化しなさい．
<ul>
<li>dBodyID  dmCreateCapsule(double p[3], double R[12], double l,  double r);</li>
<li>位置　p[3], 　姿勢　R[12],  半径 r, 　質量　m,  長軸の方向　dir</li>
</ul>
</li>
</ol>
</li>
<p><br class="spacer_" /></p>
<p><br class="spacer_" /></p>
<p><br class="spacer_" /></p>
<ul>
</ul>
