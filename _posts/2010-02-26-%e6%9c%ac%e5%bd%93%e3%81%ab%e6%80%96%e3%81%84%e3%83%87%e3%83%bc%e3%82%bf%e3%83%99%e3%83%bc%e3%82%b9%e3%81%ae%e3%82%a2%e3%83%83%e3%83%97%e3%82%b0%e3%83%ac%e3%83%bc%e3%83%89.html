---
layout: post
title: 本当に怖いデータベースのアップグレード
date: 2010-02-26 21:56:16.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- misc
tags: []
meta:
  _edit_last: '2'
  views: '160'
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/misc/6345.html"
---
<p>demura.netはSAKURAインターネットのレンタルサーバ（スタンダード）を使っています．今まで，WordPress2.8を使っていましたが，少し時間に余裕ができたので最新バージョンの2.9.2へアップグレードしました．今回はデータベースのアップグレードもあり本当に危なかった．普及まで１週間かかりました．．．</p>
<p>WordPressには自動アップグレードの機能がありますが，それを利用するためにはデータベースMySQLのバージョンが５番代でなければいけません．SAKURAインターネットのスタンダードではデータベースを１個しかもてないので，現在バージョン４のデータベースを保存し，それをバージョン５のデータベースを作りエクスポートしなければなりません．この作業を失敗すると今まで１０年間以上かけた努力の結晶であるブログが跡形もなく消え去ってしまいます．非常に危険な作業です．</p>
<p>以下，作業メモを残しておきます．ただし，この記録は不完全で正確ではないので，このとおりやらないでください．このとおりやってデータベースが消えても私は一切保障できません．</p>
<ul>
<li>バックアップを取る
<ul>
<li>ファイルのバックアップ
<ul>
<li>サーバーのwordpress以下のファイルをftpでダウンロード</li>
</ul>
</li>
<li>データベースのバックアップ
<ul>
<li>WordPress Database Backupプラグインを使用</li>
<li>念のため，SAKURAインターネットコントロールパネルからphpAdminでデータベースをエクスポートする．</li>
</ul>
</li>
<li>SAKURAコントロールパネルから現在バージョン４のデータベースを削除し，バージョン５のデータベースを新規作成する．</li>
</ul>
</li>
<li>データベースのインポート
<ul>
<li>phpAdminを使って保存したデータベースのデータをインポートする．しかし，ファイルサイズが16MB以上はできない．不幸にも保存してあったデータは235MBもある．困った．</li>
<li>１６MB以上の場合はsshでSAKURAのサーバに入り，そこからコマンドラインでmysqlコマンドを実行すればできるらしい．
<ul>
<li>mysql --host=mysql***.db.sakura.jp  -u ****  -p &lt;  保存していたデータベースファイル名</li>
<li>ところがエラー．大いに困る．</li>
</ul>
</li>
</ul>
</li>
<li>データベースを元に戻す
<ul>
<li>インターネットで色々調べて，色々試してみたがうまくいかない．そこで，元の状態に戻せばうまくいくかもしれないとひらめき，バージョン５のデータベースをSAKURAのコントロールパネルから削除しようとするがエラーでできない．</li>
<li>ますます困る．そこでmysqlについて勉強する．dropコマンドを使ってデータベースを削除できることがわかる．
<ul>
<li>drop  database データベース名（SAKURAの場合はユーザ名）</li>
</ul>
</li>
<li>なんとかバージョン5のデータベースを削除でき，再度，バージョン４のデータベースを作成する．</li>
<li>mysqlコマンドを使い保存していたデータをインポート．同じバージョンなら問題なくでき無事普及．</li>
</ul>
</li>
<li>またまた，データベースの保存
<ul>
<li>今度はWordPressのツールにあるエクスポートを使うことにし，データを保存する．</li>
</ul>
</li>
<li>めでたし，めでたい
<ul>
<li>SAKURAコントロールパネルからバージョン４のデータベースを削除し，バージョン５のデータベースを作る．</li>
<li>WordPressのツールのインポートの機能を使いデータをインポートする．</li>
<li>WordPressの自動アップグレード機能を使い最新のバージョン2.9.2にアップグレード．</li>
<li>無事作業が終わった．今回は２重のバックアップを取っていたので何とか普及できた．</li>
</ul>
</li>
</ul>
<p>SAKURAインターネットのスタンダードコースでは，データベースに関してはサポートの対象外なので，バージョンアップするときは良く調べてバックアップも２重，３重にしてから作業することをお勧めします．</p>
<p>私のようにビール片手でバージョンアップすると取り返しのつかないことになるかもしれませんよ．</p>
<p style="text-align: right;">でむ</p>
