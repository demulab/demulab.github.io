---
layout: post
title: Kinect V2 + Ubuntu14.04 メモ
date: 2017-02-09 23:43:29.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- robocup@home
tags: []
meta:
  _edit_last: '2'
  _oembed_a482d83b5c193ba6736434c9c62d8887: "{{unknown}}"
  views: '4521'
  _oembed_54a0aa0fa0b73a14d5b102aa52a8488f: "{{unknown}}"
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/robot/athome/13165.html"
---
<p>Kinect V2をUbuntu14.04で使用する設定をしたときのメモ。<br />
カーネル3.16以上、USB3.0必須。<br />
libfreenect2とiai_kinect2が必要。<br />
OpenCLのインストールで少しはまったので記録に残す。OpenCLを使うとIntelの内蔵GPUを使えるので高速処理可能。</p>
<p>1. libfreenect2のインストール<br />
<a href="https://github.com/OpenKinect/libfreenect2">https://github.com/OpenKinect/libfreenect2</a><br />
のLinuxの部分を実行。</p>
<ul>
<li>Get source
<ul>
<li>git clone https://github.com/OpenKinect/libfreenect2.git</li>
<li>cd libfreenect2</li>
<li>cd depends; ./download_debs_trusty.sh</li>
</ul>
</li>
<li>build tool
<ul>
<li>sudo apt-get install build-essential cmake pkg-config</li>
</ul>
</li>
<li>libusb
<ul>
<li>sudo dpkg -i debs/libusb*deb</li>
</ul>
</li>
<li>TURBO JPEG
<ul>
<li>sudo apt-get install libturbojpeg libjpeg-turbo8-dev</li>
</ul>
</li>
<li>OpenGL
<ul>
<li>sudo dpkg -i debs/libglfw3*deb; sudo apt-get install -f</li>
<li>sudo apt-get install libgl1-mesa-dri-lts-vivid（他のパッケージとコンフリクトしたら、インストールしない）</li>
</ul>
</li>
<li>OpenCL
<ul>
<li>sudo apt-add-repository ppa:floe/beignet; sudo apt-get update; sudo apt-get install beignet-dev; sudo dpkg -i debs/ocl-icd*deb</li>
</ul>
</li>
<li>Build
<ul>
<li>cd ..</li>
<li>mkdir build &amp;&amp; cd build</li>
<li><code>cmake .. - DCMAKE_INSTALL_PREFIX=$HOME/freenect2</code></li>
<li>make</li>
<li>make install</li>
</ul>
</li>
<li>UDEV設定
<ul>
<li>sudo cp ../platform/linux/udev/90-kinect2.rules /etc/udev/rules.d/</li>
</ul>
</li>
<li>Test
<ul>
<li>./bin/Protonect  gl  (opengl利用）</li>
<li>./bin/Protonect cl   (opencl利用）<br />
ウインドウに次のような画像が写っていない場合はopenclのインストールが失敗。</li>
</ul>
</li>
</ul>
<p><a href="http://demura.net/athome/13165.html/attachment/kitchen2" rel="attachment wp-att-13169"><img src="{{ site.baseurl }}/assets/images/2017/02/kitchen2-1024x657.png" alt="" width="800" height="513" class="aligncenter size-large wp-image-13169" /></a></p>
<p>2. iai_kinect2のインストール<br />
<a href="https://github.com/code-iai/iai_kinect2">https://github.com/code-iai/iai_kinect2</a><br />
ROSでKinect2を使うために上記のサイトの説明インストールする。</p>
<ul>
<li>Install
<ul>
<li>cd ~/catkin_ws/src/</li>
<li>git clone https://github.com/code-iai/iai_kinect2.git</li>
<li>cd iai_kinect2</li>
<li>rosdep install -r --from-paths .</li>
<li>cd ~/catkin_ws</li>
<li>catkin_make -DCMAKE_BUILD_TYPE="Release"</li>
</ul>
</li>
<li>kinect2を接続して、次のラウンチファイルを起
<ul>
<li>roslaunch kinect2_bridge kinect2_bridge.launch</li>
</ul>
</li>
<li><a href="https://github.com/code-iai/iai_kinect2/tree/master/kinect2_calibration#calibrating-the-kinect-one">ここを読んでキャリブレーション</a></li>
<li>kinect2_bridgeを次のコマンドで再起動
<ul>
<li>roslaunch kinect2_bridge kinect2_bridge.launch　(depthの処理にopenclを利用)</li>
<li>roslaunch kinect2_bridge kinect2_bridge.launch depth_method:=opengl  (depth処理にopenglを利用）</li>
</ul>
</li>
<li>クラウドビュアーで表示
<ul>
<li> rosrun kinect2_viewer kinect2_viewer kinect2 sd cloud</li>
</ul>
</li>
<li>イメージビュアーで表示
<ul>
<li>rosrun kinect2_viewer kinect2_viewer kinect2 sd image</li>
</ul>
</li>
</ul>
<p>３．　はまったところ<br />
libfreenect2のProtonectでKinect V2からのイメージ画像とデプス画像を表示できたが、iai_kinect2のkinect2_viewerでは表示できなかった。原因はopenclのインストールがうまくいっていないことだった。roslaunch kinect2_bridge kinect2_bridge.launchのコマンドではdepthの処理にopenclをデフォルトで使うが、Protonectは標準でopenglを使っていたので原因特定まで半日要した。</p>
<p>つまり、openclでうまく動かない時は、以下を実行すればよい。</p>
<ul>
<li>roslaunch kinect2_bridge kinect2_bridge.launch depth_method:=opengl</li>
<li>Image Viewer
<ul>
<li>rosrun kinect2_viewer kinect2_viewer kinect2 sd image</li>
</ul>
</li>
<li>Cloud Viewer
<ul>
<li>rosrun kinect2_viewer kinect2_viewer kinect2 sd cloud</li>
</ul>
</li>
</ul>
<p>終わり</p>
