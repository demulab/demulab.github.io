---
layout: post
title: Open Detectionのインストール
date: 2018-01-08 14:52:59.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- misc
tags: []
meta:
  _edit_last: '2'
  views: '335'
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/misc/14185.html"
---
<p>Open Detectionをインストールしたときのメモ。Open DetectoinはGoogle Summer of Code 2015 の成果を元に開発され、目的はロボット用のビジョンツール。2016年5月から更新されていないので、それほど新しい手法はない。簡単に使えて、高速なのが特徴という。簡単にビルドできるようなことが書かれているが、依存関係なのか自分の環境でビルドするのに苦労した。</p>
<p><strong>ウェブサイト</strong></p>
<ul>
<li><a href="http://opendetection.com/index.html">Open Detection</a></li>
</ul>
<p>&nbsp;</p>
<p><strong>ハードウェア環境</strong></p>
<ul>
<li>CPU: Intel(R) Core(TM) i7-8700K CPU @ 3.70GHz (6 core)</li>
<li>GPU: NVIDIA GTX 1080Ti</li>
<li>Memory: 32GB</li>
</ul>
<p>&nbsp;</p>
<p><strong>ソフトウェア環境</strong></p>
<ul>
<li>Ubuntu16.04</li>
<li>CUDA9.0</li>
</ul>
<ul>
<li>OpenCV3.4.0
<ul>
<li>OpenCV ContribとCudaのモジュールが必要。</li>
<li><a href="http://demura.net/misc/14118.html">インストールはここを参照。</a></li>
</ul>
</li>
<li>VTK6
<ul>
<li>sudo apt install vtk6  libvtk6-dev</li>
</ul>
</li>
<li>PCL1.8
<ul>
<li><a href="http://demura.net/misc/14188.html">インストールはここを参照。</a></li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p><strong>ダウンロードと展開</strong></p>
<ul>
<li>cd ~/src</li>
<li>git clone https://github.com/krips89/opendetection.git</li>
<li><a href="http://svmlight.joachims.org/">SVMLightのウェブサイト</a>へ行き、ソースを~/src/opendetection/3rdpartyにダウンロードする。</li>
<li>cd ~/src/opendetection/3rdparty</li>
<li>tar xvzf svm_light.tar.gz</li>
</ul>
<p>&nbsp;</p>
<p><strong>ファイルの変更</strong></p>
<ul>
<li style="list-style-type: none;">
<ul>
<li>OpenCV3.4.0ではビルドでいろいろエラーが出たのでファイルを次のように変更した。</li>
<li>~/src/opendetection/CMakeLists.txtを次のように変更した。つまり、OD_SOURCE_DIRとOD_BINARY_DIRを設定し、include_directoriesを追加した。なお、９、１０行目はホームポジションを示す~は使えないので注意。</li>
</ul>
</li>
</ul>
<pre class="brush:cpp;"> 
cmake_minimum_required(VERSION 2.8)
project(OpenDetection)

set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ")

# init variables for convinience                                                               
#set(OD_SOURCE_DIR ${OpenDetection_SOURCE_DIR})                                                
#set(OD_BINARY_DIR ${OpenDetection_BINARY_DIR})                                                
set(OD_SOURCE_DIR "/home/user_name/src/opendetection")  # changed
set(OD_BINARY_DIR "/home/user_name/src/opendetection/bin") # changed

# init directories before doing all the searches and includes                                  
set(OD_CMAKE_DIR "${OpenDetection_SOURCE_DIR}/cmake" "${OpenDetection_SOURCE_DIR}/cmake/module\
s")
set(CMAKE_MODULE_PATH ${OD_CMAKE_DIR} ${CMAKE_MODULE_PATH})

# addtiion                                                                                     
include_directories(
  "~/src/opencv-3.4.0/modules/cudafilters/include"
  "~/src/opencv-3.4.0/modules/cudafeatures2d/include"
  "~/src/opencv-3.4.0/build/3rdparty"
  "~/src/pcl/pcl/apps/3d_rec_framework/include"
  "~/src/opendetection/3rdparty/pugixml-1.6/src"
  )

# include bunch of stuffs and set the appropriate variables         
</pre>
<ul>
<li style="list-style-type: none;">
<ul>
<li>~/src/opendetection/common/CMakeLists.txtを次のように、opencv_cudafeatures2dをtarget_link_librariesに追加した。</li>
</ul>
</li>
</ul>
<pre class="brush:cpp;"> 
 if(SUBSYS_DEPS)
      # target_link_libraries("${LIB_NAME}" ${SUBSYS_DEPS} )                                   
      target_link_libraries("${LIB_NAME}" opencv_cudafeatures2d ${SUBSYS_DEPS} )
    endif(SUBSYS_DEPS)
</pre>
<ul>
<li>~/src/opendetection_ros/detectors/global2D/ODFaceRecognizer.cpp
<ul>
<li>44行目と48行目を変更
<ul>
<li>変更前：cvrecognizer_ = cv::face::createFisherFaceRecognizer(num_components_, threshold_);</li>
<li>変更後：cvrecognizer_ = cv::face::FisherFaceRecognizer::create(num_components_, threshold_);</li>
</ul>
</li>
<li>７７行目
<ul>
<li>変更前：cvrecognizer_-&gt;load(files[0]);</li>
<li>変更後：cvrecognizer_-&gt;read(files[0]);</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong>ビルド</strong></p>
<ul>
<li>cd ~/src/opendetection</li>
<li>mkdir build</li>
<li>cd build</li>
<li>cmake ..</li>
<li>make -j 12</li>
<li>make install</li>
</ul>
<p>&nbsp;</p>
<p><strong>データ取得</strong></p>
<ul>
<li>cd ~/src/opendetection</li>
<li>git clone https://github.com/krips89/opendetection_data.git</li>
</ul>
<p>&nbsp;</p>
<p><strong>テスト</strong></p>
<ul>
<li>３次元の物体認識Detection 3Dを試してみる。<a href="http://opendetection.com/detection_3d.html">このUser Guideを参照。</a></li>
<li>CADのデータが必要なので、<a href="https://3dwarehouse.sketchup.com/">3D Warehouse</a>などからダウンロードして、~/data/CADModelsに保存する。3dwarehouseからcollada形式でダウンロードする。opendetectionではply形式にする必要があるので、meshlabなどでplyに変換する。なお、１つのオブジェクトに対して１つのディレクトリが必要で、ディレクトリ名はオブジェクト名にする。また、plyに変換したファイルのファイル名をMesh.plyに変更する。つまり、以下のようなファイル構造にする。
<ul>
<li>~/data/CADModels/pringles/Mesh.ply</li>
<li>~/data/CADModels/mugcup/Mesh.ply</li>
<li>~/data/CADModels/DrPepper/Mesh.ply</li>
</ul>
</li>
<li>Kinect V1をコンピュータに接続する。</li>
<li>机に識別したいオブジェクトを置く。</li>
<li>cd ~/src/opendetection/build/examples/objectdetector</li>
<li>./od_example_pc_global_real_time &lt;path_to_CAD_models&gt; &lt;trained_data_directory&gt;で実行する。この例では次のコマンドを実行する。
<ul>
<li>./od_example_pc_global_real_time  ~/data/CADModels/   ~/src/opendetection/opendetection_data/trained_data/</li>
<li>実行するとウインドウが開きリアルタイムで物体が識別された。</li>
</ul>
</li>
</ul>
<p><a href="http://demura.net/wordpress/wp-content/uploads/2018/01/opendetect_result2.png"><img src="{{ site.baseurl }}/assets/images/2018/01/opendetect_result2.png" alt="" width="962" height="565" class="aligncenter size-full wp-image-14199" /></a></p>
<p>なお、カメライメージ画像を次のとおり。上のポイントクラウド画像はマウス操作で視点を変えているので見え方がイメージ画像とは違います。</p>
<p><a href="http://demura.net/wordpress/wp-content/uploads/2018/01/kinect_image.png"><img src="{{ site.baseurl }}/assets/images/2018/01/kinect_image.png" alt="" width="205" height="109" class="aligncenter size-full wp-image-14202" /></a></p>
<p>&nbsp;</p>
<p>以上。お疲れ様。</p>
