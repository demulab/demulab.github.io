---
layout: post
title: 'ros_caffe: ROSとCaffeの連携'
date: 2018-01-31 19:11:07.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- misc
tags: []
meta:
  _edit_last: '2'
  views: '720'
  _thumbnail_id: '14253'
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/misc/14246.html"
---
<p><a href="http://demura.net/wordpress/wp-content/uploads/2018/01/swift.png"><img src="{{ site.baseurl }}/assets/images/2018/01/swift.png" alt="" width="336" height="252" class="aligncenter size-full wp-image-14253" /></a>ROSでCaffeを使うためにros_caffeパッケージをインストールしたときのメモ。このパッケージはカメラから画像トピックをcaffeで識別して、トピック/caffe_retをパブリッシュする。ros_caffeパッケージのcaffeバージョンは古いので、caffe-0.15をソースからビルドして使用する。ros_caffeのウェブサイトとは方法が違う。</p>
<p><strong>ウェブサイト</strong></p>
<ul>
<li><a href="https://github.com/tzutalin/ros_caffe">https://github.com/tzutalin/ros_caffe</a></li>
</ul>
<p><strong>ハードウェア環境</strong></p>
<ul>
<li>CPU: Intel(R) Core(TM) i7-8700K CPU @ 3.70GHz (6 core)</li>
<li>GPU: NVIDIA GTX 1080Ti</li>
<li>Memory: 32GB</li>
</ul>
<p><strong>ソフトウェア環境</strong></p>
<ul>
<li>Ubuntu16.04</li>
<li>ROS Kinetic</li>
<li>CUDA8.0</li>
</ul>
<ul>
<li>OpenCV3.4.0
<ul>
<li>OpenCV ContribとCudaのモジュールが必要。</li>
<li><a href="http://demura.net/misc/14118.html">インストールはここを参照。</a></li>
</ul>
</li>
<li><a href="https://github.com/NVIDIA/caffe/tree/caffe-0.15">Caffe-0.15</a></li>
</ul>
<p><strong>ソースの取得</strong></p>
<ul>
<li>$ <code>cd ~/catkin_ws/src</code></li>
<li>$ <code>git clone --recursive https://github.com/tzutalin/ros_caffe.git</code></li>
<li>$ <code>cd ~/catkin_ws/src/ros_caffe</code></li>
</ul>
<p>&nbsp;</p>
<p><strong>Caffeのビルド</strong></p>
<ul>
<li>すでにインストール済みの場合は次へ行く。ただし、ここではNVIDIAがフォークしたバージョン0.15を使うものとする</li>
<li>インストールしていない場合は、<a href="http://demura.net/misc/14111.html">ここを参照。</a></li>
</ul>
<p>&nbsp;</p>
<p><b>Caffeの学習</b></p>
<ul>
<li>画像データセット<a href="https://www.cs.toronto.edu/~kriz/cifar.html">CIFAR-10</a>をダウンロードする
<ul>
<li>$ cd ~/src/caffe/data/cifar10</li>
<li>$ ./get_cifar10.sh</li>
</ul>
</li>
<li>caffeで学習できるようデータ形式の変換
<ul>
<li>$ cd  ~/src/caffe/examples/cifar10</li>
<li>$ ./create_cifar10.sh</li>
</ul>
</li>
<li>学習する
<ul>
<li>$ ./train_quick.sh</li>
</ul>
</li>
</ul>
<p>&nbsp;</p>
<p><strong>ROSパッケージのビルド</strong></p>
<ul>
<li>~/catkin_src/src/ros_caffe/CMakeLists.txtの該当部分を次のように変更し、~/srcにインストールされているcaffeを使うようにする。
<ul>
<li style="list-style-type: none;">
<ul>
<li>set(CAFFE_INCLUDEDIR ~/src/caffe/include ~/src/caffe/build/include)</li>
<li>set(CAFFE_LINK_LIBRARAY ~/src/caffe/build/lib)</li>
<li>arget_link_libraries(ros_caffe_test ${catkin_LIBRARIES} ${OpenCV_LIBRARIES} caffe-nv glog)</li>
</ul>
</li>
</ul>
<p>CMakeLists.txtは次のとおり。</p>
<pre class="brush:cpp;"> 
cmake_minimum_required(VERSION 2.8.3)
project(ros_caffe)

find_package(catkin REQUIRED COMPONENTS
  roscpp roslib std_msgs sensor_msgs image_transport cv_bridge
)

set(CAFFE_INCLUDEDIR ~/src/caffe/include ~/src/caffe/build/include)
set(CAFFE_LINK_LIBRARAY ~/src/caffe/build/lib)

find_package(Boost REQUIRED COMPONENTS system)
find_package(OpenCV REQUIRED)

catkin_package(
#  INCLUDE_DIRS include                                                                                          
#  LIBRARIES ros_caffe                                                                                           
#  CATKIN_DEPENDS roscpp                                                                                         
#  DEPENDS system_lib                                                                                            
)

include_directories(
  ${catkin_INCLUDE_DIRS}
  ${OpenCV_INCLUDE_DIRS}
)
include_directories(${CAFFE_INCLUDEDIR})

link_directories(${CAFFE_LINK_LIBRARAY})
add_executable(ros_caffe_test src/ros_caffe_test.cpp)
target_link_libraries(ros_caffe_test ${catkin_LIBRARIES} ${OpenCV_LIBRARIES} caffe-nv glog)
</pre>
</li>
<li>~/catkin_ws/src/ros_caffe/src/ros_caffe_test.cpp
<ul>
<li>15行目を使用するカメラのトピック名に変更する。デフォルトはcamera/rgb/image_raw。
<ul>
<li>const std::string RECEIVE_IMG_TOPIC_NAME = "/usb_cam/image_raw";</li>
</ul>
</li>
<li>model_path, weights_path, mean_file, label_file, image_pathを次のように変更する。
<ul>
<li>model_path = "/home/user_name/src/caffe/examples/cifar10/cifar10_quick.prototxt";</li>
<li>weights_path = "/home/user_name/src/caffe/examples/cifar10/cifar10_quick_iter_4000.caffemodel.h5";</li>
<li>mean_file = "/home/user_name/src/caffe/examples/cifar10/mean.binaryproto";</li>
<li>label_file = "/home/user_name/src/caffe/data/cifar10/batches.meta.txt";</li>
<li>image_path = "/home/user_name/src/caffe/examples/images/cat.jpg";</li>
</ul>
</li>
</ul>
</li>
<li>$ cd catkin_ws</li>
<li>$ catkin_make</li>
</ul>
<p><b>実行</b></p>
<ul>
<li> 端末を開いて次のコマンドを実行
<ul>
<li>$ roscore</li>
</ul>
</li>
<li>もう一つ端末を開いて次のコマンドを実行
<ul>
<li>$ rosrun ros_caffe  ros_caffe_test</li>
</ul>
</li>
<li>実行結果</li>
</ul>
<p style="padding-left: 90px;"><code><br />
Test default image under /data/cat.jpg<br />
0.2988 - "dog"<br />
0.2924 - "cat"<br />
0.2087 - "deer"<br />
0.1653 - "bird"<br />
0.0326 - "horse"<br />
</code></p>
<p><strong>Webカメラを使った実行</strong></p>
<ul>
<li>$ sudo apt install ros-kinetic-usb-cam</li>
<li>端末を４つ開いて以下のコマンドを実行
<ul>
<li style="list-style-type: none;">
<ul>
<li>$ <code>roscore</code></li>
<li>$ <code>rosrun usb_cam usb_cam_node</code></li>
<li>$ <code>rosrun image_view image_view image:=/usb_cam/image_raw</code></li>
<li>$ <code>rosrun ros_caffe ros_caffe_test</code></li>
</ul>
</li>
</ul>
<p>&nbsp;</li>
</ul>
<p><strong>ROSトピック</strong></p>
<ul>
<li>識別結果
<ul>
<li>$ rostopic echo　/caffe_ret</li>
</ul>
</li>
<li>CIFAR-10はairplane, automobile, bird, cat, deer, dog, frog, horse, ship, truckの10クラスの識別用データ・セット。試しに、swiftの画像をカメラで取得したところ約96%の確率でautomobileと識別できた。</li>
</ul>
<p><a href="http://demura.net/wordpress/wp-content/uploads/2018/01/swift_text.png"><img src="{{ site.baseurl }}/assets/images/2018/01/swift_text.png" alt="" width="677" height="174" class="aligncenter size-full wp-image-14252" /></a></p>
<p>以上</p>
