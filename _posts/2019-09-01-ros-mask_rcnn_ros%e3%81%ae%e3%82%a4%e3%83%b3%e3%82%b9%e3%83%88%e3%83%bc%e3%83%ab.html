---
layout: post
title: 'ROS: mask_rcnn_rosのインストール'
date: 2019-09-01 13:06:47.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- deeplearning
- robot
tags: []
meta:
  _edit_last: '2'
  views: '260'
  _quads_config_visibility: a:0:{}
  the_page_seo_title: ''
  the_page_meta_description: ''
  the_page_meta_keywords: ''
  the_page_noindex: '0'
  the_page_nofollow: '0'
  the_page_canonical_url: ''
  the_page_ads_novisible: '0'
  page_type: default
  the_page_read_time_novisible: '0'
  the_page_toc_novisible: '0'
  update_level: high
  redirect_url: ''
  the_page_no_amp: '0'
  _custom_css: ''
  _custom_js: ''
  the_page_memo: ''
  sns_image_url: ''
  the_review_enable: '0'
  the_review_name: ''
  the_review_rate: '5'
  the_review_type: Product
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/robot/16022.html"
---
<p>mask_rcnn_rosをインストールしたときのメモ。</p>
<ul>
<li>環境
<ul>
<li>Ubunutu16.04</li>
<li>ROS Kinetic</li>
</ul>
</li>
<li>次のサイトからgit cloneする
<ul>
<li><a href="https://github.com/iKrishneel/mask_rcnn_ros">Mask RCNN Object Detector</a></li>
<li>$ cd ~/catkin_ws/src</li>
<li>$ git clone https://github.com/iKrishneel/mask_rcnn_ros</li>
<li><code>$ git pull --all</code></li>
</ul>
</li>
<li>Pythonの仮想環境virtualenvを使う。ライブラリバージョンの依存関係が強いのでvirtualenvを使うと便利。なお、サイトではpython3でないと動かないとあるが、ROS Kineticはpython2推奨なのでpython2でインストールする。学習などはROSパッケージではないmask_rcnnを使う。
<ul>
<li>インストール
<ul>
<li>sudo pip2 install virtualenv</li>
<li>sudo pip2 install virtualenvwrapper</li>
</ul>
</li>
<li>環境設定
<ul>
<li>~/.bashrcに以下を追加
<ul>
<li>export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python2</li>
<li>export WORKON_HOME=~/.virtualenvs</li>
<li>source /usr/local/bin/virtualenvwrapper.sh</li>
</ul>
</li>
</ul>
</li>
<li>仮想環境の生成
<ul>
<li>$ venv_name=mrcnn</li>
<li>$ <code>mkvirtualenv --python=python2 $venv_name</code></li>
</ul>
</li>
<li>依存関係のインストール
<ul>
<li>$ cd ~/catkin_ws/src/mask_rcnn_ros</li>
<li>$ workon mrcnn
<ul>
<li>仮想環境に入るとプロンプトの前に(mrcnn)と表示する</li>
</ul>
</li>
<li>(mrcnn) $ pip install -r requirements.txt</li>
<li>仮想環境から抜ける
<ul>
<li>(mrcnn) $ deactivate</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>パッケージのダウンロード<code></code>
<ul>
<li><code>$ cd ~/catkin_ws/src/mask_rcnn_ros</code></li>
<li><code>$ git submodule update --init</code></li>
</ul>
</li>
<li>ビルド
<ul>
<li>$ catkin build mask_rcnn_ros</li>
</ul>
</li>
<li>実行
<ul>
<li>$ workon mrcnn</li>
<li>Publisherとしてノード実行
<ul>
<li>(mrcnn) $ roslaunch object_detector object_detector.launch image:=&lt;image_topic_name&gt; is_service:=false debug:=true</li>
</ul>
</li>
<li>Serviceとしてノード実行
<ul>
<li>(mrcnn) $ roslaunch object_detector object_detector.launch image:=&lt;image_topic_name&gt; is_service:=true debug:=false</li>
</ul>
</li>
<li>roslaunchの引数
<ul>
<li>image: 画像トピック名</li>
<li>is_service: サービスのときはtrue、それ以外はfalse</li>
<li>debug: trueにするとデバッグ用に画像がopencvのcv.imshow()で表示される。</li>
<li>detection_threshold: 検出の閾値 [0, 1]</li>
<li>model: kerasモデルファイルのパス.　モデルの拡張子はh5。</li>
<li>class_labels: クラス名とラベルがマッピングされたテキストファイル</li>
</ul>
</li>
</ul>
</li>
<li>エラーがでた場合
<ul>
<li>実行時に以下のエラーがある場合：mask_rcnn_ros/src/mask_rcnn_ros/model.pyのtopologyをすべてsavingに置換する。
<ul>
<li><code>Module 'keras.engine.topology' has no attribute 'load_weights_from_hdf5_group_by_name'</code></li>
<li><code>File "/src/mask_rcnn_ros/src/mask_rcnn_ros/model.py", line 2004, in load_weights<br />
topology.load_weights_from_hdf5_group_by_name(f, layers)<br />
NameError: global name 'topology' is not defined<br />
</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>以上</p>
