---
layout: post
title: ROS演習8-2019：地図作成・自己位置推定 (gmapping, amcl)
date: 2019-11-27 17:21:55.000000000 +09:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- education
tags: []
meta:
  _edit_last: '2'
  _thumbnail_id: '15451'
  views: '1722'
  _quads_config_visibility: a:0:{}
  the_page_seo_title: ''
  the_page_meta_description: ''
  the_page_meta_keywords: ''
  the_page_noindex: '0'
  the_page_nofollow: '0'
  the_page_canonical_url: ''
  the_page_ads_novisible: '0'
  page_type: default
  the_page_read_time_novisible: '0'
  the_page_toc_novisible: '0'
  update_level: high
  the_review_enable: '0'
  the_review_type: Product
  the_review_name: ''
  the_review_rate: '5'
  redirect_url: ''
  the_page_no_amp: '0'
  _custom_css: ''
  _custom_js: ''
  the_page_memo: ''
  sns_image_url: ''
  _wp_old_date: '2019-10-15'
author:
  login: demu
  email: info@demura.net
  display_name: demu
  first_name: ''
  last_name: ''
permalink: "/education/16294.html"
---
<p><a href="http://demura.net/wordpress/wp-content/uploads/2018/11/Screenshot-from-2018-12-06-00-13-23.png"><img class="aligncenter size-full wp-image-15451" src="{{ site.baseurl }}/assets/images/2019/11/Screenshot-from-2018-12-06-00-13-23.png" alt="" width="1279" height="700" /></a></p>
<p>この記事は私が金沢工業大学ロボティクス学科で担当している2019年度後学期開講の講義ロボットプログラミングⅡ用です。今回は地図作成にgmappingパッケージと自己位置推定にamclパッケージを使いロボットにナビゲーションをさせましょう！　本記事を以下の記事を参考にしています。</p>
<p>なお、gmappingは占有格子地図をベースとしたFastSLAMのパッケージで、amclはモンテカルロ位置同定の一種であるAdaptive Monte Carlo Localizationのパッケージとなっています。</p>
<ul>
<li><a href="https://turtlebot3.readthedocs.io/en/latest/slam.html">10 SLAM</a></li>
<li><a href="https://turtlebot3.readthedocs.io/en/latest/navigation.html">11 Navigation</a></li>
</ul>
<p><strong>１．　地図生成</strong></p>
<p>(1)　端末を３つ開き以下のコマンドを実行する。</p>
<p>gazeboシミュレータを起動。<a href="https://demura.net/education/16291.html">ROS演習７-2019</a>の演習準備を実行し、事前に建物の3Dファイルfmt_world.tarをダウンロードして指定場所に保存する必要あり。</p>
<ul>
<li><code>$ export TURTLEBOT3_MODEL=burger</code></li>
<li><code>$ roslaunch turtlebot3_gazebo turtlebot3_fmt_world.launch</code></li>
</ul>
<p>地図生成のgmappingを起動</p>
<ul>
<li><code>$ export TURTLEBOT3_MODEL=burger</code></li>
<li><code>$ roslaunch turtlebot3_slam turtlebot3_slam.launch slam_methods:=gmapping</code></li>
<li><span style="color: #ff0000;">注1：rvizがOpenGL関係のエラーで落ちる場合は、以下の１行を.bashrcの最後に付け加える</span>
<ul>
<li><span style="color: #ff0000;">export LIBGL_ALWAYS_SOFTWARE=1</span></li>
</ul>
</li>
<li><span style="color: #ff0000;">注2：エラーがでる場合はgmappingのパッケージが入っていない可能性がありますので、以下のコマンドでインストールしてください。</span>
<ul>
<li><span style="color: #ff0000;">sudo apt install ros-melodic-gmapping</span></li>
</ul>
</li>
</ul>
<p>(2)　端末を開き、以下のコマンドでロボットを動かし、地図を作る。</p>
<ul>
<li><code>$ roslaunch turtlebot3_teleop turtlebot3_teleop_key.launch</code></li>
</ul>
<p>(3)  端末を開き、以下のコマンドで地図を保存する。mymapは保存する地図名なので適宜変更する。</p>
<ul>
<li><code>$ mkdir  ~/maps</code></li>
<li><code>$ rosrun map_server map_saver -f  ~/maps/mymap</code></li>
</ul>
<p>&nbsp;</p>
<p><strong>２．　ナビゲーション</strong></p>
<p>一度開いている端末を全部閉じ、ノードを落とす。</p>
<p>(1)  gazeboシミュレータを起動</p>
<ul>
<li><code>$ export TURTLEBOT3_MODEL=burger</code></li>
<li><code>$ roslaunch turtlebot3_gazebo turtlebot3_world.launch</code></li>
</ul>
<p>(2) 自己位置推定ノードの起動<br />
上で作成した地図を使ってナビゲーションをする。</p>
<ul>
<li><code>$ export TURTLEBOT3_MODEL=burger</code></li>
<li><code>$ roslaunch turtlebot3_navigation turtlebot3_navigation.launch map_file:=$HOME/maps/mymap.yaml</code></li>
</ul>
<p>(3) (2)のコマンドで rvizも起動するが、rvizを別に起動したい場合は以下のコマンドを使う。</p>
<ul>
<li><code>$ rviz <span class="nt">-d</span> <span class="sb">`</span>rospack find turtlebot3_slam<span class="sb">`</span>/rviz/turtlebot3_navigation.rviz</code></li>
</ul>
<p>(4) ロボット初期位置の設定<br />
上で起動したrviz（上図）の"2D Pose Estimation"をクリックして選択し、下図シミュレータのロボットの向きと位置が合うように、rviz上でロボットの位置と向きを設定する。ロボットの位置にマウスのカーソールを持って行き、ロボットの向きにドラッグすると設定終わり。</p>
<p>(5) ゴールの設定<br />
次にrvizの"2D Nav Goal"をクリックして、初期位置を設定したのと同様に、ゴールの位置と向きを設定する。設定するとロボットが自動で動き出す。</p>
<p><a href="https://demura.net/wordpress/wp-content/uploads/2019/11/building.jpg"><img class="aligncenter size-large wp-image-16407" src="{{ site.baseurl }}/assets/images/2019/11/building-1024x617.jpg" alt="" width="1024" height="617" /></a></p>
<p><strong>３．演習</strong></p>
<ul>
<li>上の説明に従って建物の地図を作り、スタート地点からゴールまでロボットをナビゲーションさせてみよう。スタート地点は上図で上空に伸びている青い線、初期位置(0, 0)、ゴールは上図の右上にあるポールです。なお、地図上の格子は一辺が1[m]です。どうなるかな？</li>
</ul>
<p>終わり</p>
